<!DOCTYPE html>
<html data-theme="dark">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PHPFuck - PHP 8</title>
    <script src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/js/all.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/fontawesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/1.0.4/css/bulma.min.css">
    <script src="js/php-parser.min.js"></script>
    <script src="js/php-unparser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ace-builds/src-min-noconflict/ace.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ace-builds/src-noconflict/snippets/php.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/ace-builds/css/ace.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.es5.min.js"></script>
    <style>
        * {
            font-family: monospace !important;
        }

        .textarea {
            height: 400px;
            margin-bottom: 1em;
        }

        ul#chars {
            list-style: none;
        }

        .ace_editor {
            min-height: 400px;
            border-radius: 5px;
            margin-bottom: 1rem;
        }
    </style>
</head>

<body>
    <section class="section">
        <div class="container">
            <h1 class="title">
                PHPFuck - PHP 8
            </h1>
            <hr>
            <p class="subtitle">
                Write (almost) valid PHP 8 code using only 8 different characters: <code>()[]-+.^</code>.
            </p>

            <div class="columns">
                <div class="column">
                    <div id="editor"></div>

                    <div class="columns">
                        <div class="column has-text-right">
                            <div class="control has-icons-left">
                                <div class="select">
                                    <select name="mode" id="currentMode">
                                        <option value="">Try to translate PHP code</option>
                                        <option value="create_function">Wrap inside create_function()</option>
                                        <option value="assert">Wrap inside assert(function(){})</option>
                                        <option value="custom">Wrap inside custom $function()</option>
                                    </select>
                                    <span class="icon is-left">
                                        <i class="fas fa-wrench"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="column">
                            <input class="input is-one-quarter" type="text"
                                placeholder="PHP function to call"
                                name="customFunc" id="customFunc"
                                value="system"
                            />
                        </div>
                    </div>

                    <div class="columns" id="translationOptions">
                        <div class="column has-text-right">
                            <div class="control has-icons-left">
                                <div class="select">
                                    <select name="mode" id="currentAssign">
                                        <option value="" selected>Do not encode variables</option>
                                        <option value="extract">Use extract() to store variables</option>
                                        <option value="putenv">Use putenv() to store variables</option>
                                    </select>
                                    <span class="icon is-left">
                                        <i class="fas fa-file-code"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="column">
                    <div id="output"></div>
                    <p class="buttons">
                        <button class="button" id="download">
                            <span class="icon">
                                <i class="fas fa-download"></i>
                            </span>
                            <span>Download</span>
                        </button>
                        <button class="button" id="copy">
                            <span class="icon">
                                <i class="far fa-copy"></i>
                            </span>
                            <span>Copy to clipboard</span>
                        </button>
                        <button class="button is-pulled-right" id="test">
                            <span class="icon">
                                <i class="fas fa-play"></i>
                            </span>
                            <span>Test on onlinephp.io</span>
                        </button>
                    </p>

                    <div class="is-pulled-right">
                        <span id="stats">0 chars.</span>
                    </div>
                </div>
            </div>

            <div class="content">
                <h1 class="title is-5">Links</h1>
                <ul>
                    <li>View source code on <a href="https://github.com/phpfuckteam">GitHub</a> (Python CLI
                        version).</li>
                    <li>Test any encoded code at <a href="https://phpfuck.com">PHPFuck</a> or <a
                            href="http://jsfuck.com/">JSFuck</a>.</li>
                </ul>
                <h1 class="title is-5">How It Works?</h1>
                <ul id="chars"></ul>
            </div>

        </div>
    </section>
    <script src="./phpfuck.js"></script>
    <script>
        const phpfuck = new PHPFuck();
        const DEFAULT_VALUE = `<?php
var_dump(filter_input_array(5),phpversion());
system('whoami');
`;

        (function () {
            'use strict';
            const editor = ace.edit(document.querySelector('#editor'), {
                mode: 'ace/mode/php',
                theme: 'ace/theme/monokai',
                selectionStyle: 'text',
                value: DEFAULT_VALUE,
                wrap: true,
            })
            const output = ace.edit(document.querySelector('#output'), {
                mode: 'ace/mode/php',
                theme: 'ace/theme/monokai',
                selectionStyle: 'text',
                value: DEFAULT_VALUE,
                readOnly: true,
                wrap: true,
            })

            const ul = document.getElementById('chars');

            for(const c in phpfuck.charMapping) {
                const li = document.createElement('li');
                const span = document.createElement('code');
                const pre = document.createElement('code');
                span.style.width = '2rem';
                span.style.textAlign = 'center';
                span.style.display = 'inline-block';
                span.innerHTML = (c.charCodeAt(0) < 33 ? {
                    '\n': '\\n',
                    '\0': '\\0',
                }[c] || c : c)
                    .replace(/&/g, '&amp;')
                    .replace(/ /g, '&nbsp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/'/g, '&#39;')
                    .replace(/"/g, '&#34;');
                pre.innerText = phpfuck.charMapping[c];
                pre.style.display = 'inline-block';
                li.append(span, ' > ', pre);
                ul.append(li);
            }


            download.addEventListener('click', function () {
                const blob = new Blob([output.getValue()], {
                    type: "application/php"
                });
                const elem = document.createElement('a');
                elem.href = URL.createObjectURL(blob);
                elem.download = 'phpfucked.php';
                document.body.appendChild(elem);
                elem.click();
                document.body.removeChild(elem);
            });

            copy.addEventListener('click', function () {
                var sel = output.selection.toJSON(); // save selection
                output.selectAll();
                output.focus();
                document.execCommand('copy');
                output.selection.fromJSON(sel);
            });

            function byteArrayToWordArray(ba) {
                var wa = [],
                    i;
                for (i = 0; i < ba.length; i++) {
                    wa[(i / 4) | 0] |= ba[i] << (24 - 8 * i);
                }

                return CryptoJS.lib.WordArray.create(wa, ba.length);
            }

            test.addEventListener('click', function () {
                const compressed = pako.deflateRaw(output.getValue().toString())
                const sourceCode = CryptoJS.enc.Base64url.stringify(byteArrayToWordArray(compressed))
                const queryString = new URLSearchParams({
                    s: sourceCode,
                    v: [
                        '8.4.10',
                        '8.0.30',
                        '7.4.33',
                        '7.0.33',
                        '5.6.40'
                    ].join(','),
                })
                const url = `https://onlinephp.io/?${queryString}`
                window.open(url, '_blank').focus();
            });

            function render(content) {
                customFunc.parentNode.style.display = currentMode.value == 'custom' ? 'block' : 'none';
                translationOptions.style.display = currentMode.value == '' ? 'block' : 'none';
                const encoded = phpfuck.encode(content, {
                    assign: currentAssign.value,
                    mode: currentMode.value,
                    customFunc: customFunc.value,
                })
                if (!encoded) return;
                output.setValue(encoded);
                document.getElementById('stats').textContent = `${encoded.length} chars.`;
            }

            [currentMode, currentAssign, customFunc].forEach((el) => {
                el.addEventListener('input', function (event) {
                    render(editor.getValue());
                })
            })

            editor.session.on('change', function() {
                render(editor.getValue());
            });

            render(editor.getValue());
        }(this));
    </script>
</body>

</html>